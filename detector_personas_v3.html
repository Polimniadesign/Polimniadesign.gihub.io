<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Permissions-Policy" content="camera=*">
  <title>Detector de Personas y Cascos - MVP</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    height: auto;
  }

:root {
  --max-content-width: 1280px;
}

  .header {
  display: flex;
  justify-content: flex-end; /* üî• lo manda a la derecha */
  align-items: center;

  padding: 0 32px;
  height: 60px;
}

.logo {
  height: 32px; /* ajust√° seg√∫n dise√±o */
}
ul{overflow: hidden;}
li{list-style-type: disc;}

  body {
    font-family: Arial, sans-serif;
    background: #070F26;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
    background-image: url("images/fondo_detector.jpg");
  background-size: cover;      
  background-position: center;  
  background-repeat: no-repeat;
  background-attachment: fixed; 
   
  }


  .container {
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 95%;
     margin: 0 auto;
    width: 100%;
  }

  h1 {
    text-align: center;
    margin-bottom: 10px;
    font-size: 20px !important;
  }

  .subtitle {
    text-align: center;
    color: #666;
    margin-bottom: 25px;
    font-size: 14px;
  }

  .status {
    background: #f0f0f0;
    margin-top: 10px;
    padding: 10px;
    margin-bottom: 20px;
    border-radius: 20px;
    box-sizing: border-box;
    text-align: center;
    font-weight: bold;
    font-size: 12px;
  }

  .status.loading {
    background: #fff3cd;
    color: #856404;
  }

  .status.ready {
    background: #d4edda;
    color: #155724;
  }

  .status.error {
    background: #f8d7da;
    color: #721c24;
  }
.main {
  margin: 0 auto;
  padding: 40px 32px;
max-width: 1280px;
display: grid;
  grid-template-columns: 1fr 360px;
  gap: 32px;
}
.viewer {
  display: flex;
  flex-direction: column;
}

  .video-container {
   background: white;
  border-radius: 28px 28px 0 0;
  overflow: hidden;
  box-shadow: 0 20px 50px rgba(0,0,0,.2);
  }

  .video-header {
      padding: 20px 28px;
  font-size: 20px;
  font-weight: 600;
  }

  .video-placeholder {
     position: relative;
  aspect-ratio: 16 / 9;
    background: #ffffff;
  }

  #video {
    width: 100%;
    height: auto;
    display: block;
  }

  #canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .controls {
    display: grid;
  grid-template-columns: repeat(3, 1fr);
  background: #050c2c;
  padding: 20px;
   border-radius: 0 0 28px 28px;
  }

  .controls button {
  background: none;
  border: none;
  color: white;
  text-align: center;
  cursor: pointer;
}
  button {
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    font-size: 28px;

    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    transition: all 0.3s;
  }

  button span {
    font-size: 12px;
    margin-top: 4px;
    font-weight: 500;
  }

  button:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  button:disabled {
    color: #ccc;
    cursor: not-allowed;
    transform: none;
  }

  .stats {
   display: flex;
  flex-direction: column;
  gap: 24px;
  }

  .stat-card {
     background: white;
   border-radius: 24px;
  padding: 24px;
  text-align: center;
  box-shadow: 0 16px 40px rgba(0,0,0,.15);
  color: #0072BC;
  font-weight: bold;
  }

  .stat-number {
    font-size: 48px;
  font-weight: 700;
  }

  .stat-label {
    font-size: 14px;
    opacity: 0.9;
  }

 .info {
  display: grid;
  grid-template-columns: 200px 1fr 1fr;
  align-items: center;
  gap: 32px;

  padding: 24px 32px;
  background: #fff;
}
.footer-col.instructions {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
text-align: center;
  color: #0072BC;
  font-weight: 600;
}
.footer-col.instructions img {
  width: 40px;
  height: auto;
}
.instructions{
  display: flex;
}
  .instructions h3,
  .references h3 {
    margin-bottom: 10px;
  }

  .instructions ul {
    list-style: disc;
    padding-left: 20px;
  }

  .references p {
    display: flex;
    align-items: center;
  }

  .green,
  .blue {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }

  .green {
    background: #00c853;
  }

  .blue {
    background: #2196f3;
  }

  .error-details {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 15px;
    border-radius: 5px;
    margin-top: 20px;
    font-size: 12px;
    line-height: 1.6;
    font-family: monospace;
    display: none;
  }


  @media (max-width: 1024px) {
  .main {
    grid-template-columns: 1fr;
  }

  .stats {
    flex-direction: row;
    flex-wrap: wrap;
  }

  .stat-card {
    flex: 1 1 calc(50% - 12px);
  }
}
  @media (max-width:768px) {
      .header {
    padding: 0 16px;
  }

  .logo {
    height: 28px;
  }

    .container {
      padding: 8px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 24px;
    }
 .main {
    padding: 0px;
    gap: 16px;
  }
    button {
      padding: 12px 20px;
      font-size: 14px;
    }
      .info {
    grid-template-columns: 1fr;
    text-align: left;
    font-size: 14px;
  }
  footer {
    margin-top: 16px;
  }
  .info{
    gap: 16px;
    padding: 8px;
    box-sizing: border-box;
  }
  .controls{
    padding: 12px;
  }
  .status {padding: 8px;}
  .header{height: 60px;}
  }
</style>
</head>

<body>
  <div class="container">
    <!--HEADER-->
    <header class="header">
      <img src="images/logo_nttdata.svg" alt="Logo" class="logo">
    </header>
    <!--MAIN-->
    <main class="main">
      <!--VIDEO / CANVAS-->
      <section class="viewer">
        <div class="video-container">
          <div class="video-header">
            <h1><i class="fa fa-bolt" aria-hidden="true"></i> Detector de personas y cascos</h1>
          </div>
          <div class="video-placeholder">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
          </div>
        </div>

        <!--ACCIONES-->
        <div class="controls">
          <button id="startBtn" disabled> <i class="fa-solid fa-play"></i>
            <span>Iniciar c√°mara</span></button>
          <button id="stopBtn" disabled> <i class="fa-solid fa-pause"></i>
            <span>Detener</span></button>
          <button id="switchBtn" disabled> <i class="fa-solid fa-arrows-rotate"></i>
            <span>Cambiar c√°mara</span></button>
        </div>
        <!--MENSAJES-->
        <div id="status" class="status loading">
          Cargando modelo de inteligencia artificial...
        </div>
      </section>

      <!--INDICADORES-->
      <aside class="stats">
        <div class="stat-card">
          <div class="stat-number" id="personCount">0</div>
          <div class="stat-label">Personas Detectadas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="helmetCount">0</div>
          <div class="stat-label">Cascos Detectados</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="fps">0</div>
          <div class="stat-label">FPS</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="confidence">0%</div>
          <div class="stat-label">Confianza (Personas)</div>
        </div>
      </aside>
    </main>
    <footer class="info">
      <!-- COLUMNA 1 -->
      <div class="footer-col instructions">
        <img src="images/instrucciones.svg" alt="instrucciones">
        <span>Instrucciones</span>
      </div>

      <!-- COLUMNA 2 -->
      <div class="footer-col footer-steps">
        <ul>
          <li>Hac√© clic en ‚ÄúIniciar C√°mara‚Äù para comenzar.</li>
          <li>Permit√≠ el acceso a la c√°mara cuando lo solicite.</li>
          <li>Us√° ‚ÄúCambiar C√°mara‚Äù para alternar entre frontal/trasera.</li>
        </ul>
        <!--<strong>‚ö†Ô∏è Nota MVP:</strong> Para detectar cascos se llama a Roboflow cada ~1s (no en cada frame) para que sea estable.-->
      </div>

      <!-- COLUMNA 3 -->
      <div class="footer-col references">
        <h4>Referencias:</h4>
        <p><span class="dot green"></span> Cuadro verde: personas (COCO-SSD, local).</p>
        <p><span class="dot blue"></span> Cuadro azul: personas (COCO-SSD, local).</p>
      </div>
    </footer>

    <div id="errorDetails" class="error-details"></div>
  </div>

  <!-- TensorFlow.js y COCO-SSD -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>

  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');

    let model = null;
    let stream = null;
    let isDetecting = false;
    let currentCamera = 'environment';
    let lastTime = Date.now();
    let frameCount = 0;

    const statusDiv = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const switchBtn = document.getElementById('switchBtn');

    const personCountDiv = document.getElementById('personCount');
    const helmetCountDiv = document.getElementById('helmetCount');
    const fpsDiv = document.getElementById('fps');
    const confidenceDiv = document.getElementById('confidence');
    const errorDetailsDiv = document.getElementById('errorDetails');

    // ==========================
    //  CONFIG ROBOfLOW (EDITA AQU√ç)
    // ==========================
    // IMPORTANTE: NO uses una API key que ya publicaste. Genera una nueva en Roboflow.
    // Reemplaza TU_API_KEY por tu key nueva.
    const ROBOFLOW_DETECT_URL =
      "https://detect.roboflow.com/hard-hat-mvp/1?api_key=TU_API_KEY";

    // Si tu modelo usa otra clase (ej: "hardhat" en vez de "helmet"), ponla aqu√≠.
    // Puedes dejarlo en null para aceptar ambas ("hardhat"/"helmet") sin filtrar.
    const HELMET_CLASS_NAMES = new Set(["hardhat", "helmet"]); // ajusta si tu modelo usa otro nombre

    // Llamar a Roboflow cada X ms (para MVP estable)
    const HELMET_INTERVAL_MS = 1000;

    // Umbral de confianza (0.0 a 1.0)
    const HELMET_MIN_SCORE = 0.35;

    // ==========================
    //  Estado Roboflow
    // ==========================
    let lastHelmetCheck = 0;
    let lastHelmetPreds = []; // se dibujan en cada frame, pero se actualizan cada HELMET_INTERVAL_MS

    // Funci√≥n para mostrar errores detallados
    function showError(message, details) {
      console.error(message, details);
      statusDiv.textContent = '‚ùå ' + message;
      statusDiv.className = 'status error';

      errorDetailsDiv.style.display = 'block';
      errorDetailsDiv.innerHTML = '<strong>Detalles t√©cnicos:</strong><br>' +
        JSON.stringify(details, null, 2);
    }

    // Verificar soporte del navegador
    function checkBrowserSupport() {
      const errors = [];

      if (!navigator.mediaDevices) {
        errors.push('navigator.mediaDevices no est√° disponible');
      }

      if (!navigator.mediaDevices?.getUserMedia) {
        errors.push('getUserMedia no est√° disponible');
      }

      if (window.location.protocol !== 'https:' &&
        window.location.hostname !== 'localhost' &&
        window.location.hostname !== '127.0.0.1') {
        errors.push('Se requiere HTTPS para acceder a la c√°mara (excepto localhost)');
      }

      return errors;
    }

    // ==========================
    //  Roboflow helpers
    // ==========================
    function dataURLToBlob(dataUrl) {
      const arr = dataUrl.split(",");
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr], { type: mime });
    }

    async function detectHelmetFromFrame() {
      // Captura frame del video en un canvas "offscreen"
      const off = document.createElement("canvas");
      off.width = video.videoWidth;
      off.height = video.videoHeight;
      const offCtx = off.getContext("2d");
      offCtx.drawImage(video, 0, 0, off.width, off.height);

      // Convertir a JPG (m√°s liviano)
      const dataUrl = off.toDataURL("image/jpeg", 0.7);
      const blob = dataURLToBlob(dataUrl);

      const formData = new FormData();
      formData.append("file", blob, "frame.jpg");

      const resp = await fetch(ROBOFLOW_DETECT_URL, {
        method: "POST",
        body: formData
      });

      if (!resp.ok) {
        const text = await resp.text().catch(() => "");
        throw new Error(`Roboflow ${resp.status}: ${text}`);
      }

      const json = await resp.json();

      // Roboflow devuelve predictions con x,y,width,height (x,y = centro)
      const preds = Array.isArray(json.predictions) ? json.predictions : [];

      return preds.map(p => ({
        class: p.class,
        score: p.confidence ?? p.score ?? 0,
        // convertir a bbox [x,y,w,h] con x,y esquina superior izquierda
        bbox: [
          (p.x - p.width / 2),
          (p.y - p.height / 2),
          p.width,
          p.height
        ]
      }));
    }

    // Cargar el modelo COCO-SSD
    async function loadModel() {
      try {
        const supportErrors = checkBrowserSupport();
        if (supportErrors.length > 0) {
          showError('Problemas de compatibilidad detectados', {
            errors: supportErrors,
            protocol: window.location.protocol,
            hostname: window.location.hostname,
            userAgent: navigator.userAgent
          });
          return;
        }

        statusDiv.textContent = '‚è≥ Cargando modelo de IA (Personas)...';
        statusDiv.className = 'status loading';

        model = await cocoSsd.load();

        statusDiv.textContent = '‚úÖ Modelo de personas cargado. Presiona "Iniciar C√°mara"';
        statusDiv.className = 'status ready';
        startBtn.disabled = false;

        console.log('Modelo COCO-SSD cargado correctamente');
      } catch (error) {
        showError('Error cargando el modelo', {
          error: error.message,
          stack: error.stack
        });
      }
    }

    // Iniciar c√°mara
    async function startCamera() {
      try {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }

        statusDiv.textContent = 'üì∑ Solicitando acceso a la c√°mara...';
        statusDiv.className = 'status loading';

        let constraints = {
          video: { facingMode: currentCamera },
          audio: false
        };

        try {
          stream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (firstError) {
          console.log('Primer intento fall√≥, intentando sin facingMode...');
          constraints = { video: true, audio: false };
          stream = await navigator.mediaDevices.getUserMedia(constraints);
        }

        video.srcObject = stream;
        await video.play();

        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;

          startBtn.disabled = true;
          stopBtn.disabled = false;
          switchBtn.disabled = false;

          statusDiv.textContent = 'üé• ¬°C√°mara activa! Detectando personas y cascos...';
          statusDiv.className = 'status ready';

          errorDetailsDiv.style.display = 'none';

          // reset stats
          personCountDiv.textContent = '0';
          helmetCountDiv.textContent = '0';
          fpsDiv.textContent = '0';
          confidenceDiv.textContent = '0%';

          lastHelmetPreds = [];
          lastHelmetCheck = 0;

          isDetecting = true;
          detectFrame();
        };

      } catch (error) {
        let errorMessage = 'Error accediendo a la c√°mara';
        let errorDetails = {
          name: error.name,
          message: error.message,
          constraint: error.constraint
        };

        if (error.name === 'NotAllowedError') {
          errorMessage = 'Permiso denegado para acceder a la c√°mara';
          errorDetails.solution = 'Ve a Configuraci√≥n > Permisos > C√°mara y act√≠valo';
        } else if (error.name === 'NotFoundError') {
          errorMessage = 'No se encontr√≥ ninguna c√°mara';
          errorDetails.solution = 'Verifica que tu dispositivo tenga c√°mara';
        } else if (error.name === 'NotReadableError') {
          errorMessage = 'La c√°mara est√° siendo usada por otra aplicaci√≥n';
          errorDetails.solution = 'Cierra otras apps que puedan estar usando la c√°mara';
        }

        showError(errorMessage, errorDetails);
      }
    }

    // Detener c√°mara
    function stopCamera() {
      isDetecting = false;

      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }

      video.srcObject = null;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      startBtn.disabled = false;
      stopBtn.disabled = true;
      switchBtn.disabled = true;

      statusDiv.textContent = '‚èπÔ∏è C√°mara detenida';
      statusDiv.className = 'status ready';

      personCountDiv.textContent = '0';
      helmetCountDiv.textContent = '0';
      fpsDiv.textContent = '0';
      confidenceDiv.textContent = '0%';

      lastHelmetPreds = [];
    }

    // Cambiar c√°mara
    async function switchCamera() {
      currentCamera = currentCamera === 'user' ? 'environment' : 'user';
      await startCamera();
    }

    // Dibujar caja y etiqueta
    function drawBox({ x, y, w, h, label, color }) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 4;
      ctx.strokeRect(x, y, w, h);

      // fondo texto
      ctx.fillStyle = color;
      const labelWidth = Math.min(320, Math.max(140, label.length * 10));
      ctx.fillRect(x, y - 30, labelWidth, 30);

      // texto
      ctx.fillStyle = '#000000';
      ctx.font = 'bold 18px Arial';
      ctx.fillText(label, x + 5, y - 8);
    }

    // Detectar en cada frame
    async function detectFrame() {
      if (!isDetecting || !model) return;

      try {
        // 1) Personas (local)
        const predictions = await model.detect(video);

        // Limpiar canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Personas
        const persons = predictions.filter(pred => pred.class === 'person');

        let totalConfidence = 0;
        persons.forEach(person => {
          const [x, y, width, height] = person.bbox;
          const confidence = Math.round(person.score * 100);
          totalConfidence += confidence;

          drawBox({
            x, y, w: width, h: height,
            label: `Persona ${confidence}%`,
            color: '#00ff00'
          });
        });

        personCountDiv.textContent = persons.length;

        if (persons.length > 0) {
          const avgConfidence = Math.round(totalConfidence / persons.length);
          confidenceDiv.textContent = avgConfidence + '%';
        } else {
          confidenceDiv.textContent = '0%';
        }

        // 2) Cascos (Roboflow, por intervalos)
        const now = Date.now();
        if (now - lastHelmetCheck >= HELMET_INTERVAL_MS) {
          lastHelmetCheck = now;

          detectHelmetFromFrame()
            .then(preds => {
              // filtrar por clase y confianza
              lastHelmetPreds = preds.filter(p => {
                const okScore = (p.score ?? 0) >= HELMET_MIN_SCORE;
                const cls = (p.class || "").toLowerCase();
                const okClass = HELMET_CLASS_NAMES.size === 0
                  ? true
                  : HELMET_CLASS_NAMES.has(cls);

                return okScore && okClass;
              });
            })
            .catch(err => {
              console.warn("Roboflow casco fall√≥:", err.message);
              lastHelmetPreds = [];
            });
        }

        // Dibujar cascos con el √∫ltimo resultado disponible
        let helmetCount = 0;
        lastHelmetPreds.forEach(p => {
          const [x, y, w, h] = p.bbox;
          const confidence = Math.round((p.score ?? 0) * 100);
          helmetCount++;

          drawBox({
            x, y, w, h,
            label: `Casco ${confidence}%`,
            color: '#00bfff'
          });
        });
        helmetCountDiv.textContent = helmetCount;

        // 3) FPS
        frameCount++;
        const currentTime = Date.now();
        if (currentTime - lastTime >= 1000) {
          fpsDiv.textContent = frameCount;
          frameCount = 0;
          lastTime = currentTime;
        }

      } catch (error) {
        console.error('Error en detecci√≥n:', error);
      }

      requestAnimationFrame(detectFrame);
    }

    // Event Listeners
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    switchBtn.addEventListener('click', switchCamera);

    // Cargar modelo al iniciar
    loadModel();

    // Detener c√°mara al salir
    window.addEventListener('beforeunload', () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    });

    // Debug
    console.log('Info navegador:', {
      userAgent: navigator.userAgent,
      protocol: window.location.protocol,
      hostname: window.location.hostname,
      mediaDevices: !!navigator.mediaDevices,
      getUserMedia: !!navigator.mediaDevices?.getUserMedia
    });
  </script>
</body>

</html>